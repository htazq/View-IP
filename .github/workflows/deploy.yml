# GitHub Actions å·¥ä½œæµï¼šè‡ªåŠ¨éƒ¨ç½²åˆ° EdgeOne Pages
# å‚è€ƒ .cnb.yml é…ç½®ï¼Œä¿æŒä¸ CNB.cool éƒ¨ç½²æµç¨‹ä¸€è‡´
name: Deploy to EdgeOne Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤ 2ï¼šå‡†å¤‡éƒ¨ç½²ç›®å½•ï¼ˆä¸ .cnb.yml çš„ prepare-deploy é˜¶æ®µä¸€è‡´ï¼‰
      - name: Prepare deployment files
        run: |
          mkdir -p deploy-temp/functions
          # éƒ¨ç½² IP Dashboard å‡½æ•°
          # éƒ¨ç½²ä¸ºæ ¹è·¯å¾„ (index)
          cp edge-functions/ip/index.js deploy-temp/functions/index.js
          # éƒ¨ç½²ä¸º /app è·¯å¾„ (ç”¨äºå‰ç«¯ JS èµ„æº)
          cp edge-functions/ip/index.js deploy-temp/functions/app.js
          ls -la deploy-temp/
          echo "âœ… éƒ¨ç½²ç›®å½•å‡†å¤‡å®Œæˆ"

      # æ­¥éª¤ 3ï¼šéƒ¨ç½²åˆ° EdgeOne Pagesï¼ˆä¸ .cnb.yml çš„ deploy-to-eopages é˜¶æ®µä¸€è‡´ï¼‰
      - name: Deploy to EdgeOne Pages
        env:
          EDGEONE_API_TOKEN: ${{ secrets.EDGEONE_API_TOKEN }}
        run: |
          # ä½¿ç”¨å®˜æ–¹ EdgeOne Pages éƒ¨ç½²é•œåƒ
          docker run --rm \
            -v ${{ github.workspace }}/deploy-temp:/workspace \
            -e EDGEONE_API_TOKEN=$EDGEONE_API_TOKEN \
            tencentcom/deploy-eopages:latest \
            edgeone pages deploy /workspace -n worker-ip -t $EDGEONE_API_TOKEN

          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "ğŸŒ è®¿é—®åœ°å€: https://ip.at9.net"

      # æ­¥éª¤ 4ï¼šéƒ¨ç½²æ‘˜è¦
      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ éƒ¨ç½²æ–‡ä»¶: deploy-temp/functions/"
          echo "ğŸš€ éƒ¨ç½²å¹³å°: EdgeOne Pages"
          echo "ğŸŒ åœ¨çº¿è®¿é—®: https://ip.at9.net"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # æ­¥éª¤ 5ï¼šéƒ¨ç½²å¤±è´¥é€šçŸ¥
      - name: Deployment Failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "è¯·æ£€æŸ¥ï¼š"
          echo "1. EDGEONE_API_TOKEN æ˜¯å¦æ­£ç¡®é…ç½®"
          echo "2. EdgeOne Pages æœåŠ¡æ˜¯å¦æ­£å¸¸"
          echo "3. æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

